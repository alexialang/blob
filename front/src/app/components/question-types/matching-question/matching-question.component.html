<div class="matching-question-container">

  <div id="matching-instructions" class="sr-only">
    Instructions pour l'accessibilité : Utilisez Tab pour naviguer entre les éléments. Appuyez sur Entrée pour
    sélectionner un élément de gauche, puis un élément de droite pour les connecter. Appuyez sur Suppr pour supprimer
    une connexion. Appuyez sur Échap pour annuler une sélection.
  </div>

  <div class="matching-area" #matchingContainer>
    <canvas #canvas class="connection-canvas" aria-hidden="true"></canvas>

    <div class="matching-columns">
      <div class="left-column">
        <div class="items-list" role="group" aria-label="Éléments à associer">
          <div
            *ngFor="let item of leftColumn; let i = index"
            class="matching-item left-item"
            [attr.data-id]="item.id"
            [class.connected]="matches[item.id.toString()]"
            [class.selected-keyboard]="selectedLeftForKeyboard === item.id.toString()"
            [class.focused]="focusedElement === item.id.toString()"
            tabindex="0"
            role="button"
            [attr.aria-label]="getAriaLabel(item, 'left', i)"
            [attr.aria-describedby]="getAriaDescribedBy()"
            [attr.aria-pressed]="selectedLeftForKeyboard === item.id.toString()"
            (keydown)="onKeyDown($event, item.id.toString(), 'left')"
            (focus)="onFocus(item.id.toString())"
            (blur)="onBlur()"
          >
            <div class="item-content">
              <span class="item-text">{{ item.answer }}</span>
              <img 
                [src]="getFlowerShape(i)" 
                alt="Point de connexion floral" 
                class="connection-point left-point flower-connection" 
                [style.filter]="matches[item.id.toString()] ? 
                  'brightness(0) saturate(100%) invert(42%) sepia(93%) saturate(1352%) hue-rotate(' + getHueRotation(item.id.toString()) + 'deg) brightness(119%) contrast(119%)' : 
                  'brightness(0) saturate(0%) contrast(50%)'"
                [style.color]="matches[item.id.toString()] ? getConnectionColor(item.id.toString()) : '#666'"
                aria-hidden="true"
              />
            </div>
            <button
              *ngIf="matches[item.id.toString()]"
              class="remove-connection"
              (click)="removeConnection(item.id.toString())"
              [attr.aria-label]="'Supprimer la connexion de ' + item.answer"
              title="Supprimer cette connexion"
            >
              ✕
            </button>
          </div>
        </div>
      </div>

      <div class="right-column">
        <div class="items-list" role="group" aria-label="Associations possibles">
          <div
            *ngFor="let item of rightColumn; let i = index"
            class="matching-item right-item"
            [attr.data-id]="item.id"
            [class.connected]="isRightItemConnected(item.id.toString())"
            [class.focused]="focusedElement === item.id.toString()"
            [class.available]="selectedLeftForKeyboard && !isRightItemConnected(item.id.toString())"
            tabindex="0"
            role="button"
            [attr.aria-label]="getAriaLabel(item, 'right', i)"
            [attr.aria-describedby]="getAriaDescribedBy()"
            [attr.aria-disabled]="isRightItemConnected(item.id.toString())"
            (keydown)="onKeyDown($event, item.id.toString(), 'right')"
            (focus)="onFocus(item.id.toString())"
            (blur)="onBlur()"
          >
            <div class="item-content">
              <img 
                [src]="getFlowerShape(i)" 
                alt="Point de connexion floral" 
                class="connection-point right-point flower-connection" 
                [style.filter]="isRightItemConnected(item.id.toString()) ? 
                  'brightness(0) saturate(100%) invert(42%) sepia(93%) saturate(1352%) hue-rotate(' + getHueRotation(getConnectedLeftId(item.id.toString())) + 'deg) brightness(119%) contrast(119%)' : 
                  'brightness(0) saturate(0%) contrast(50%)'"
                [style.color]="isRightItemConnected(item.id.toString()) ? getConnectionColor(getConnectedLeftId(item.id.toString())) : '#666'"
                aria-hidden="true"
              />
              <span class="item-text">{{ item.answer }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="matching-instructions">
    <div class="instruction-item">
      <span>Tracez une ligne ou utilisez Entrée pour connecter</span>
    </div>
    <div class="instruction-item">
      <span>Tab pour naviguer, Suppr pour supprimer</span>
    </div>
    <div class="instruction-item">
      <span>Associez tous les éléments pour valider</span>
    </div>
  </div>

  <div class="validation-area">
    <div class="progress-indicator" aria-live="polite">
      {{ getMatchesCount() }} / {{ leftColumn.length }} associations complétées
    </div>
    <button
      class="validate-btn"
      [disabled]="!canValidate()"
      (click)="validateAnswer()"
      [attr.aria-label]="
        canValidate() ? 'Valider les associations' : 'Complétez toutes les associations avant de valider'
      "
    >
      Valider les associations
    </button>
  </div>
</div>
