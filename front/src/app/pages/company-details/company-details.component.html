<div class="company-details-page">

<div class="container">
  <div *ngIf="company">
    <h1 class="page-title">Détails <br /> de <span class="company-highlight" [ngStyle]="{ 'color': highlightColor }">{{ company.name }}</span></h1>
    <div class="company-info">
      <p class="company-address">Adresse non renseignée</p>
      <div class="company-stats">
        <div class="stat-item">
          <span class="stat-number">{{ company.users?.length || 0 }}</span>
          <span class="stat-label">Collaborateurs</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ company.groups?.length || 0 }}</span>
          <span class="stat-label">Groupes</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ getActiveUsersCount() }}</span>
          <span class="stat-label">Actifs</span>
        </div>
      </div>
    </div>

    <div class="actions d-flex gap-2 mb-4">
      <button class="btn btn-primary" (click)="editCompany()">
        Modifier
      </button>
      <button class="btn btn-danger" (click)="deleteCompany()">
        Supprimer
      </button>
    </div>

    <ng-container *ngIf="canViewStats">
      <div class="company-statistics-section mb-4">
        <h3 class="section-title">Statistiques de l'entreprise</h3>
        <app-global-statistics [companyId]="company?.id ?? null"></app-global-statistics>
      </div>
    </ng-container>

    <div class="tabs-container mb-4">
      <div class="tabs-header">
        <button
          class="tab-button"
          [class.active]="activeTabIndex === 0"
          (click)="activeTabIndex = 0"
        >
          Groupes
        </button>
      </div>
    </div>

    <ng-container *ngIf="activeTabIndex === 0">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Groupes de l'entreprise</h3>
        <button tuiButton size="s" appearance="primary" (click)="showCreateGroupModalAction()">
          Créer un groupe
        </button>
      </div>

      <ng-container *ngIf="company.groups?.length; else noGroupsTpl">
        <div *ngFor="let g of company.groups" class="group-container mb-3">
          <div class="group-header d-flex justify-content-between align-items-center p-3 border rounded">
            <div class="d-flex align-items-center">
              <button tuiButton size="xs" appearance="flat" (click)="toggleGroup(g)" class="me-2">
                {{ g.expanded ? '▼' : '▶' }}
              </button>
              <span><strong>{{ g.name }}</strong></span>
            </div>
            <div class="group-actions">
              <button tuiButton size="xs" appearance="outline" (click)="addMemberToGroup(g.id)" class="me-2">
                Ajouter membre
              </button>
              <button tuiButton size="xs" appearance="secondary" (click)="deleteGroup(g.id)">
                Supprimer
              </button>
            </div>
          </div>

          <div *ngIf="g.expanded" class="group-content p-3 border-start border-end border-bottom rounded-bottom">
            <p *ngIf="g.description" class="text-muted mb-3">{{ g.description }}</p>
            <p *ngIf="!g.users?.length">Aucun membre</p>
            <table *ngIf="g.users?.length" class="table table-sm">
              <thead>
              <tr>
                <th>Prénom</th>
                <th>Nom</th>
                <th>Email</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let m of g.users">
                <td>{{ m.firstName }}</td>
                <td>{{ m.lastName }}</td>
                <td>{{ m.email }}</td>
                <td>{{ m.isActive ? 'Actif' : 'Inactif' }}</td>
                <td>
                  <button tuiButton size="xs" appearance="secondary" (click)="removeUserFromGroup(g.id, m.id)">
                  Retirer
                </button>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </ng-container>
    </ng-container>

    <div class="collaborators-section mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Collaborateurs</h2>
        <button tuiButton size="s" appearance="primary" (click)="showAddMemberModalAction()">
          Ajouter un membre
        </button>
      </div>
      <div class="filters d-flex gap-2 mb-3">
        <select class="form-control" [(ngModel)]="filterByGroup" (ngModelChange)="applyFilters()">
          <option value="">Tous groupes</option>
          <option *ngFor="let g of groupList" [value]="g">{{ g }}</option>
        </select>

        <select class="form-control" [(ngModel)]="filterByStatus" (ngModelChange)="applyFilters()">
          <option value="">Tous statuts</option>
          <option value="active">Actif</option>
          <option value="inactive">Inactif</option>
        </select>

        <input class="form-control" placeholder="Recherche..." [(ngModel)]="searchKeyword" (ngModelChange)="applyFilters()" />
      </div>

      <table tuiTable size="m" class="custom-table table-striped mb-3">
        <thead>
        <tr tuiThGroup>
          <th tuiTh>Nom</th>
          <th tuiTh>Email</th>
          <th tuiTh (click)="sortBy('isActive')" style="cursor: pointer;">
            Actif
            <span *ngIf="sortColumn === 'isActive'">
                {{ sortDirection === 'asc' ? '↑' : '↓' }}
              </span>
          </th>
          <th tuiTh>Groupes</th>
          <th tuiTh>Statistiques</th>
          <th tuiTh>Droits</th>
          <th tuiTh>Actions</th>
        </tr>
        </thead>
        <tbody tuiTbody>
        <tr *ngFor="let c of pagedCollaborators">
          <td tuiTd>{{ c.name }}</td>
          <td tuiTd>{{ c.email }}</td>
          <td tuiTd>{{ c.isActive ? 'Oui' : 'Non' }}</td>
          <td tuiTd>
            <div class="groups-container">
              <span *ngFor="let group of c.groups.slice(0, 2)" class="group-badge">
                {{ group }}
              </span>
              <span *ngIf="c.groups.length > 2" class="group-badge group-badge-more">
                +{{ c.groups.length - 2 }}
              </span>
            </div>
          </td>
          <td tuiTd>
            <button tuiButton appearance="action-grayscale" size="s">
              {{ getCollaboratorStats(c.id) }} <span>Voir plus</span>
            </button>
          </td>
          <td tuiTd>
            <div class="rights-container">
              <span *ngFor="let right of c.rights.slice(0, 3)" class="right-badge">
                {{ right }}
              </span>
              <span *ngIf="c.rights.length > 3" class="right-badge right-badge-more">
                +{{ c.rights.length - 3 }}
              </span>
            </div>
          </td>
          <td tuiTd>
            <div class="d-flex gap-2">
              <button tuiButton size="xs" appearance="outline">Voir</button>
              <button tuiButton size="xs" appearance="secondary" (click)="deleteCollaborator(c.id)">Supprimer</button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>

      <app-pagination [totalItems]="filteredCollaborators.length" [pageSize]="pageSize" [page]="page" (pageChange)="onPageChange($event)"></app-pagination>
    </div>

    <div *ngIf="showAddMemberModal" class="modal-overlay">
      <div class="modal-container">
        <ng-container *ngIf="company?.id as companyId">
          <app-add-member-modal
            [companyId]="companyId"
            (memberAdded)="onMemberAdded($event)"
            (modalClosed)="onModalClosed()"
          ></app-add-member-modal>
        </ng-container>
      </div>
    </div>

    <div *ngIf="showCreateGroupModal" class="modal-overlay">
      <div class="modal-content">
        <h3>Créer un groupe</h3>
        <input [(ngModel)]="newGroupName" placeholder="Nom du groupe" class="form-control mb-2" />
        <textarea [(ngModel)]="newGroupDescription" placeholder="Description" class="form-control mb-2"></textarea>
        <h4>Membres</h4>
        <div class="mb-2">
          <button (click)="selectAllMembers()">Tout sélectionner</button>
          <button (click)="deselectAllMembers()">Tout désélectionner</button>
        </div>
        <ul class="list-unstyled mb-3" style="max-height: 200px; overflow-y: auto;">
          <li *ngFor="let u of availableMembersForNewGroup">
            <label>
              <input type="checkbox" [checked]="isMemberSelected(u.id)" (change)="toggleMemberSelection(u.id)" />
              {{ u.firstName }} {{ u.lastName }} ({{ u.email }})
            </label>
          </li>
        </ul>
        <div class="d-flex justify-content-end gap-2">
          <button tuiButton size="s" appearance="secondary" (click)="cancelCreateGroup()">Annuler</button>
          <button tuiButton size="s" appearance="primary" (click)="confirmCreateGroup()">Valider</button>
        </div>
      </div>
    </div>
  </div>
</div>

</div>

<ng-template #noGroupsTpl>
  <p class="no-data">Aucun groupe trouvé.</p>
</ng-template>
