<div class="container">
  <div class="stats-graph-container" style="margin-bottom: 20px;">
    <h3>Statistiques globales</h3>
    <canvas height="200"></canvas>
  </div>

  <h1 class="page-title">Gestion <br /> des Quiz</h1>

  <div class="filters-container">
    <div class="filters-row">
      <select
        class="form-control"
        [(ngModel)]="filterStatus"
        (ngModelChange)="applyFilters()"
      >
        <option value="">Statut</option>
        <option *ngFor="let status of statusOptions" [value]="status">
          {{ status }}
        </option>
      </select>

      <input
        type="text"
        class="form-control"
        placeholder="Mot-clé"
        [(ngModel)]="filterKeyword"
        (ngModelChange)="applyFilters()"
      />

      <button tuiButton class="form-control" (click)="applyFilters()">
        Rechercher
      </button>
    </div>

    <div class="dropdown-wrapper">
      <div
        tuiDropdownLimitWidth="fixed"
        tuiGroup
        [tuiDropdown]="dropdown"
        [(tuiDropdownOpen)]="open"
        class="dropdown-container"
      >
        <button class="custom-dropdown-btn">Actions</button>
        <button
          #tuiDropdownHost
          tuiChevron
          tuiIconButton
          class="custom-dropdown-chevron"
          type="button"
        ></button>
      </div>
      <ng-template #dropdown>
        <tui-data-list>
          <button
            tuiOption
            type="button"
            (click)="onCreateQuiz()"
          >
            Créer un quiz
          </button>
          <button
            tuiOption
            type="button"
            (click)="onClick()"
          >
            Exporter
          </button>
          <button
            tuiOption
            type="button"
            (click)="onClick()"
          >
            Importer
          </button>
        </tui-data-list>
      </ng-template>
    </div>
  </div>

  <div *ngIf="loadError" class="alert alert-danger">
    Impossible de charger les quiz.
  </div>

  <div class="table-scroll-wrapper">
    <table tuiTable class="custom-table table-striped">
      <thead>
      <tr>
        <th tuiTh class="th-checkbox">
          <input
            type="checkbox"
            tuiCheckbox
            [ngModel]="allSelected"
            (ngModelChange)="toggleAll($event)"
          />
        </th>
        <th tuiTh (click)="sortBy('title')" class="th-quiz">
          Quiz
          <button
            tuiIconButton
            size="xs"
            class="sort-btn"
            *ngIf="sortColumn === 'title'"
            [iconStart]="sortDirection === 'asc' ? 'tuiIconChevronUp' : 'tuiIconChevronDown'"
          ></button>
        </th>
        <th tuiTh class="th-creator">Créateur</th>
        <th tuiTh class="th-groups">Groupes</th>
        <th tuiTh (click)="sortBy('category')" class="th-category">
          Catégorie
          <button
            tuiIconButton
            size="xs"
            class="sort-btn"
            *ngIf="sortColumn === 'category'"
            [iconStart]="sortDirection === 'asc' ? 'tuiIconChevronUp' : 'tuiIconChevronDown'"
          ></button>
        </th>
        <th tuiTh (click)="sortBy('stats')" class="th-stats">
          Statistique du quiz
          <button
            tuiIconButton
            size="xs"
            class="sort-btn"
            *ngIf="sortColumn === 'stats'"
            [iconStart]="sortDirection === 'asc' ? 'tuiIconChevronUp' : 'tuiIconChevronDown'"
          ></button>
        </th>
        <th tuiTh>Public</th>
        <th tuiTh>Statut</th>
        <th tuiTh class="th-action">
          Action
          <button
            tuiButton
            appearance="action"
            size="xs"
            iconStart="@tui.trash"
            tuiIconButton
            (click)="deleteSelected()"
            [disabled]="!hasSelection"
            class="btn-delete-all"
          ></button>
        </th>
      </tr>
      </thead>

      <tbody tuiTbody>
      <tr *ngFor="let row of pagedRows" class="table-row">
        <td tuiTd>
          <input type="checkbox" tuiCheckbox [(ngModel)]="row.selected" />
        </td>
        <td tuiTd class="td-quiz">
          <div [tuiCell]="size" class="d-flex align-center gap-2 quiz-cell">
            <tui-avatar [size]="size">{{ row.title.charAt(0) }}</tui-avatar>
            <div>
              <div tuiTitle>{{ row.title }}</div>
              <div tuiSubtitle *ngIf="row.description">
                {{ row.description }}
              </div>
            </div>
          </div>
        </td>
        <td tuiTd class="td-creator">{{ row.createdBy }}</td>
        <td tuiTd class="td-groups">
          <div class="groups-container">
            <tui-chip
              *ngFor="let group of getVisibleGroups(row.groups)"
              [size]="'s'"
              class="group-chip"
            >
              {{ group.name }}
            </tui-chip>
            <tui-chip
              *ngIf="getRemainingGroupsCount(row.groups) > 0"
              [size]="'s'"
              class="group-chip group-chip-more"
              [tuiHint]="getGroupsTooltip(row.groups)"
              tuiHintDirection="top"
            >
              +{{ getRemainingGroupsCount(row.groups) }}
            </tui-chip>
          </div>
        </td>
        <td tuiTd class="td-category">{{ row.category || '—' }}</td>
        <td tuiTd class="td-stats">{{ row.stats || '—' }}</td>
        <td tuiTd class="td-public">{{ row.isPublic ? 'Oui' : 'Non' }}</td>
        <td tuiTd class="td-status">{{ row.status }}</td>
        <td tuiTd class="td-action">
          <div class="d-flex gap-2">
            <a class="link-profile">Voir détails</a>
            <button
              tuiButton
              appearance="action"
              size="xs"
              iconStart="@tui.pencil"
              tuiIconButton
              class="btn-edit"
            ></button>
            <button
              tuiButton
              appearance="action"
              size="xs"
              iconStart="@tui.trash"
              tuiIconButton
              class="btn-delete-single"
              (click)="deleteSingle(row.id)"
            ></button>
          </div>
        </td>
      </tr>
      <tr *ngIf="rows.length === 0">
        <td tuiTd colspan="9" class="no-data">Aucun quiz trouvé.</td>
      </tr>
      </tbody>
    </table>


  </div>

  <div class="pagination-container">
    <app-pagination
      [totalItems]="rows.length"
      [pageSize]="pageSize"
      [page]="page"
      [activePadding]="2"
      (pageChange)="onPageChange($event)"
    ></app-pagination>
  </div>
</div>
