<div class="page-container">
  <div class="page-header">
    <div class="page-title">
      <h1>Cr√©er <span class="quiz-highlight" [ngStyle]="{ color: highlightColor }"> une partie</span></h1>

      <p>Invitez vos coll√®gues et amis pour un quiz multijoueur</p>
    </div>
  </div>

  <div class="page-content">
    <div class="create-room-card" *ngIf="!loading">
      <div class="card-header">
        <h2>Configuration de la partie</h2>
        <button class="close-btn" (click)="goBack()" aria-label="Fermer">√ó</button>
      </div>

      <div class="quiz-info" *ngIf="quizData">
        <div class="quiz-preview">
          <div class="quiz-icon">üéØ</div>
          <div class="quiz-details">
            <h3>{{ quizData.title }}</h3>
            <p>{{ quizData.questions?.length || 0 }} questions</p>
          </div>
        </div>
      </div>

      <form class="room-form" (ngSubmit)="createRoom()" #roomForm="ngForm">
        <div class="form-section">
          <h3>Param√®tres de base</h3>

          <div class="form-group">
            <label for="roomName">Nom du salon (optionnel)</label>
            <input
              type="text"
              id="roomName"
              class="form-input"
              [(ngModel)]="roomName"
              name="roomName"
              placeholder="Salon de {{ getCurrentUsername() }}"
              maxlength="50"
            />
          </div>

          <div class="form-group">
            <label for="maxPlayers">Nombre maximum de joueurs</label>
            <select id="maxPlayers" class="form-select" [(ngModel)]="maxPlayers" name="maxPlayers" required>
              <option value="2">2 joueurs</option>
              <option value="3">3 joueurs</option>
              <option value="4" selected>4 joueurs</option>
              <option value="6">6 joueurs</option>
              <option value="8">8 joueurs</option>
            </select>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="isTeamMode" name="isTeamMode" />
              <span class="checkmark"></span>
              Mode √©quipe (2 √©quipes)
            </label>
            <small class="help-text"> Les joueurs seront r√©partis en 2 √©quipes qui s'affrontent </small>
          </div>
        </div>

        <div class="form-section">
          <h3>Inviter des participants</h3>

          <div class="form-group">
            <div class="radio-group">
              <label class="radio-label">
                <input
                  type="radio"
                  value="group"
                  [(ngModel)]="invitationType"
                  name="invitationType"
                  (change)="onInvitationTypeChange()"
                />
                <span class="radio-mark"></span>
                Inviter un groupe
              </label>
              <label class="radio-label">
                <input
                  type="radio"
                  value="users"
                  [(ngModel)]="invitationType"
                  name="invitationType"
                  (change)="onInvitationTypeChange()"
                />
                <span class="radio-mark"></span>
                Choisir des utilisateurs
              </label>
            </div>
          </div>

          <div class="form-group" *ngIf="invitationType === 'group'">
            <label for="groupSelect">Choisir un groupe</label>
            <select
              id="groupSelect"
              class="form-select"
              [(ngModel)]="selectedGroupId"
              name="selectedGroupId"
              (change)="onGroupChange()"
            >
              <option value="">-- S√©lectionner un groupe --</option>
              <option *ngFor="let group of availableGroups" [value]="group.id">
                {{ group.name }} ({{ group.users?.length || 0 }} membres)
              </option>
            </select>
          </div>

          <div class="form-group" *ngIf="invitationType === 'users'">
            <label>Choisir des utilisateurs ({{ getSelectedUsersCount() }}/{{ maxPlayers }})</label>

            <div class="users-list" *ngIf="availableUsers && availableUsers.length > 0; else noUsersMessage">
              <div
                *ngFor="let user of availableUsers"
                class="user-item"
                [class.selected]="isUserSelected(user.id)"
                [class.disabled]="!isUserSelected(user.id) && selectedUserIds.length >= maxPlayers - 1"
                (click)="onUserToggle(user.id)"
              >
                <div class="user-avatar">
                  {{ user.firstName?.charAt(0) || 'U' }}{{ user.lastName?.charAt(0) || '' }}
                </div>
                <div class="user-info">
                  <span class="user-name">{{ user.firstName }} {{ user.lastName }}</span>
                  <span class="user-email">{{ user.email }}</span>
                </div>
                <div class="user-checkbox">
                  <span *ngIf="isUserSelected(user.id)">‚úì</span>
                </div>
              </div>
            </div>

            <ng-template #noUsersMessage>
              <div class="no-users-message" style="text-align: center; padding: 20px; color: #666">
                <p>Aucun utilisateur disponible dans votre entreprise.</p>
                <p>V√©rifiez que vous avez bien des coll√®gues dans votre entreprise.</p>
              </div>
            </ng-template>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="goBack()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="!roomForm.valid || creating || !canCreateRoom()">
            <span *ngIf="creating">Cr√©ation...</span>
            <span *ngIf="!creating">Cr√©er le salon</span>
          </button>
        </div>
      </form>
    </div>

    <div class="loading-container" *ngIf="loading">
      <div class="spinner"></div>
      <p>Chargement du quiz...</p>
    </div>
  </div>
</div>
