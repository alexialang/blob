<div class="quiz-game" [attr.data-hide-nav]="true">
  <div *ngIf="waitingForPlayers && !quizCompleted && !showFeedback" class="waiting-screen">
    <div class="waiting-content">
      <div class="waiting-icon">‚è≥</div>
      <h3 class="waiting-title">En attente des autres joueurs</h3>
      <div class="waiting-progress">
        <span class="progress-text">{{ playersAnswered.length }}/{{ totalPlayers }} joueurs ont r√©pondu</span>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="(playersAnswered.length / totalPlayers) * 100"></div>
        </div>
      </div>
      <div class="waiting-players">
        <div *ngFor="let player of playersAnswered" class="player-ready">
          <span class="player-check">‚úÖ</span>
          <span class="player-name">{{ player }}</span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!quizCompleted && !showFeedback" class="quiz-header">
    <div class="logo">
      <img src="/assets/svg/logo.svg" alt="BLOB" />
    </div>

    <div class="quiz-info">
      <div class="timer" [class.warning]="timeLeft <= 10">
        <span class="timer-icon">‚è±Ô∏è</span>
        <span class="timer-text">{{ timeLeft }}s</span>
      </div>
      <div class="score">
        <span class="score-icon">üèÜ</span>
        <span class="score-text">{{ getCurrentNormalizedScore() }}/100</span>
      </div>
    </div>

    <div class="user-info">
      <span class="username">{{ currentUser?.username || 'Joueur' }}</span>
      <div class="user-level">
        <span class="level-badge">MULTI</span>
        <div class="user-avatar" role="img" [attr.aria-label]="'Avatar de ' + (currentUser?.username || 'Joueur')">
          <span>{{ (currentUser?.username || 'U').charAt(0).toUpperCase() }}</span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="false" class="live-scoreboard-container">
    <app-live-scoreboard
      [players]="livePlayers"
      [currentQuestionIndex]="getCurrentQuestionDisplayIndex()"
      [totalQuestions]="totalQuestions"
      [showRanking]="true"
    >
    </app-live-scoreboard>
  </div>

  <div *ngIf="!quizCompleted && !showFeedback" class="progress-container">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
  </div>

  <div *ngIf="currentQuestion && !showFeedback && !quizCompleted && !showTransition" class="question-container">
    <div class="question-number">Question {{ getCurrentQuestionDisplayIndex() }} / {{ totalQuestions }}</div>
    <h1 class="question-text">{{ currentQuestion.question }}</h1>
  </div>

  <div *ngIf="currentQuestion && !showFeedback && !quizCompleted && !showTransition" class="question-type-container">
    <p
      class="question-instruction"
      *ngIf="currentQuestion.type_question?.name === 'MCQ' || currentQuestion.type_question?.name === 'QCM'"
    >
      Choisissez la bonne r√©ponse parmi les propositions.
    </p>
    <p class="question-instruction" *ngIf="currentQuestion.type_question?.name === 'multiple_choice'">
      S√©lectionnez toutes les r√©ponses correctes.
    </p>
    <p class="question-instruction" *ngIf="currentQuestion.type_question?.name === 'right_order'">
      Remettez les √©l√©ments dans le bon ordre.
    </p>
    <p class="question-instruction" *ngIf="currentQuestion.type_question?.name === 'matching'">
      Associez chaque √©l√©ment de gauche √† son correspondant de droite.
    </p>
    <p class="question-instruction" *ngIf="currentQuestion.type_question?.name === 'find_the_intruder'">
      Rep√©rez l'intrus parmi les propositions.
    </p>
    <p class="question-instruction" *ngIf="currentQuestion.type_question?.name === 'blind_test'">
      √âcoutez l'extrait et identifiez l'artiste ou le titre.
    </p>
    <p class="question-instruction" *ngIf="currentQuestion.type_question?.name === 'true_false'">
      Indiquez si l'√©nonc√© est vrai ou faux.
    </p>

    <app-mcq-question
      *ngIf="currentQuestion.type_question?.name === 'MCQ' || currentQuestion.type_question?.name === 'QCM'"
      [question]="currentQuestion"
      [progress]="{
        current: currentQuestionIndex + 1,
        total: totalQuestions,
        percentage: totalQuestions === 0 ? 0 : ((currentQuestionIndex + 1) / totalQuestions) * 100,
      }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-mcq-question>

    <app-multiple-choice-question
      *ngIf="currentQuestion.type_question?.name === 'multiple_choice'"
      [question]="currentQuestion"
      [progress]="{
        current: getCurrentQuestionDisplayIndex(),
        total: totalQuestions,
        percentage: getProgressPercentage(),
      }"
      (answerSelected)="onAnswersSelected($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-multiple-choice-question>

    <app-right-order-question
      *ngIf="currentQuestion.type_question?.name === 'right_order'"
      [question]="currentQuestion"
      [progress]="{
        current: getCurrentQuestionDisplayIndex(),
        total: totalQuestions,
        percentage: getProgressPercentage(),
      }"
      (answerSelected)="onOrderChanged($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-right-order-question>

    <app-true-false-question
      *ngIf="currentQuestion.type_question?.name === 'true_false'"
      [question]="currentQuestion"
      [progress]="{
        current: getCurrentQuestionDisplayIndex(),
        total: totalQuestions,
        percentage: getProgressPercentage(),
      }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-true-false-question>

    <app-matching-question
      *ngIf="currentQuestion.type_question?.name === 'matching'"
      [question]="currentQuestion"
      [progress]="{
        current: getCurrentQuestionDisplayIndex(),
        total: totalQuestions,
        percentage: getProgressPercentage(),
      }"
      (answerSelected)="onMatchingAnswersSelected($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-matching-question>

    <app-intruder-question
      *ngIf="currentQuestion.type_question?.name === 'find_the_intruder'"
      [question]="currentQuestion"
      [progress]="{
        current: getCurrentQuestionDisplayIndex(),
        total: totalQuestions,
        percentage: getProgressPercentage(),
      }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-intruder-question>

    <app-blind-test-question
      *ngIf="currentQuestion.type_question?.name === 'blind_test'"
      [question]="currentQuestion"
      [progress]="{
        current: getCurrentQuestionDisplayIndex(),
        total: totalQuestions,
        percentage: getProgressPercentage(),
      }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="submitAnswer()"
    >
    </app-blind-test-question>
  </div>

  <div
    *ngIf="showFeedback"
    @slideFeedback
    class="full-feedback"
    [class.correct]="overlayCorrect"
    [class.incorrect]="!overlayCorrect"
  >
    <div class="ff-content">
      <h1 class="ff-title">
        {{ overlayCorrect ? 'Bonne r√©ponse!' : 'Mauvaise r√©ponse!' }}
      </h1>

      <p class="ff-score">Score: {{ getCurrentNormalizedScore() }}/100</p>

      <div *ngIf="currentQuestion" class="ff-correct-list">
        <h3>Bonne(s) r√©ponse(s)&nbsp;:</h3>
        <ng-container *ngFor="let answer of currentQuestion.answers">
          <span *ngIf="answer.is_correct" class="ff-answer">{{ answer.answer }}</span>
        </ng-container>
      </div>
    </div>
  </div>

  <div *ngIf="quizCompleted" class="quiz-end-screen">
    <div class="end-content">
      <app-back-button> </app-back-button>
      <h1 class="end-title">Quiz termin√© !</h1>
      <div class="background-blob">
        <div class="final-score">
          <div class="score-circle">
            <span class="score-text">Votre score est de :</span>
            <span class="score-number">{{ getCurrentNormalizedScore() }}</span>
            <span class="score-max">/ 100</span>
          </div>
        </div>

        <div class="ranking-section">
          <h2>Votre classement</h2>
          <div class="ranking-position">
            <span class="position-badge">#{{ playerRank }}</span>
            <span class="position-text">/ sur {{ totalPlayers }} joueurs</span>
          </div>

          <app-slide-button
            class="leaderboard-btn"
            label="Voir le classement complet"
            [negative]="true"
            backgroundColor="var(--color-dark)"
            (buttonClick)="replayQuiz()"
          >
          </app-slide-button>
        </div>
        <div class="end-actions">
          <button class="share-btn" (click)="shareQuiz()"><tui-icon icon="@tui.share-2" /> Partager</button>
          <button class="back-btn" (click)="replayQuiz()">
            <tui-icon icon="@tui.rotate-ccw" [style.color]="'var(--color-ligth)'" /> Rejouer
          </button>
        </div>
      </div>

      <div class="rating-circle">
        <div class="rating-section">
          <h3>Noter ce quiz</h3>
          <div class="star-rating">
            <span
              *ngFor="let star of [1, 2, 3, 4, 5]; trackBy: trackByStar"
              class="star"
              [class.filled]="star <= userRating"
              [class.hover]="star <= hoverRating"
              (click)="rateQuiz(star)"
              (mouseenter)="hoverRating = star"
              (mouseleave)="hoverRating = 0"
            >
              <tui-icon
                icon="@tui.star"
                [style.color]="star <= userRating || star <= hoverRating ? '#ffd700' : 'rgba(255, 255, 255, 0.3)'"
              >
              </tui-icon>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-multiplayer-transition
    [players]="transitionPlayers"
    [questionNumber]="currentQuestionIndex"
    [totalQuestions]="totalQuestions"
    [show]="showTransition"
    [duration]="transitionDuration"
  >
  </app-multiplayer-transition>
</div>
