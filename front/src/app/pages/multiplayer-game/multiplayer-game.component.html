<div class="quiz-game" [attr.data-hide-nav]="true">

  <div *ngIf="waitingForPlayers && !quizCompleted && !showFeedback" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9998; background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; text-align: center;">
    <h3>‚è≥ En attente des autres joueurs...</h3>
    <p>{{ playersAnswered.length }}/{{ totalPlayers }} joueurs ont r√©pondu</p>
    <div style="margin-top: 10px;">
      <div *ngFor="let player of playersAnswered" style="color: #4CAF50;">‚úÖ {{ player }}</div>
    </div>
  </div>

  <div *ngIf="hasAnswered && !waitingForPlayers && !quizCompleted && !showFeedback"
       style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9998; background: rgba(76, 175, 80, 0.9); color: white; padding: 20px; border-radius: 10px; text-align: center; animation: fadeIn 0.5s ease-in;">
    <h3>R√©ponse valid√©e !</h3>
    <p>Votre r√©ponse a √©t√© enregistr√©e.</p>
    <p>Attendez que tous les joueurs r√©pondent...</p>
  </div>


  <div *ngIf="!quizCompleted && !showFeedback" class="quiz-header">
    <div class="logo">
      <img src="/assets/svg/logo.svg" alt="BLOB">
    </div>

    <div class="quiz-info">
      <div class="timer" [class.warning]="timeLeft <= 10">
        <span class="timer-icon">‚è±Ô∏è</span>
        <span class="timer-text">{{ timeLeft }}s</span>
      </div>
      <div class="score">
        <span class="score-icon">üèÜ</span>
        <span class="score-text">{{ getCurrentNormalizedScore() }}/100</span>
      </div>
    </div>

    <div class="user-info">
      <span class="username">{{ currentUser?.username || 'Joueur' }}</span>
      <div class="user-level">
        <span class="level-badge">MULTI</span>
        <div class="user-avatar">
          <span>{{ getUserInitials() }}</span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!quizCompleted && !showFeedback" class="progress-container">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
    </div>
  </div>

  <div *ngIf="currentQuestion && !showFeedback && !quizCompleted" class="question-container">
    <div class="question-number">Question {{ currentQuestionIndex }} / {{ totalQuestions }}</div>
    <h1 class="question-text">{{ currentQuestion.question }}</h1>
  </div>

  <div *ngIf="currentQuestion && !showFeedback && !quizCompleted" class="question-type-container">

    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'MCQ' || currentQuestion.type_question?.name === 'QCM'">
      Choisissez la bonne r√©ponse parmi les propositions.
    </p>
    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'multiple_choice'">
      S√©lectionnez toutes les r√©ponses correctes.
    </p>
    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'right_order'">
      Remettez les √©l√©ments dans le bon ordre.
    </p>
    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'matching'">
      Associez chaque √©l√©ment de gauche √† son correspondant de droite.
    </p>
    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'find_the_intruder'">
      Rep√©rez l'intrus parmi les propositions.
    </p>
    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'blind_test'">
      √âcoutez l'extrait et identifiez l'artiste ou le titre.
    </p>
    <p class="question-instruction"
       *ngIf="currentQuestion.type_question?.name === 'Vrai/Faux'">
      Indiquez si l'√©nonc√© est vrai ou faux.
    </p>

    <app-mcq-question
      *ngIf="currentQuestion.type_question?.name === 'MCQ' || currentQuestion.type_question?.name === 'QCM'"
      [question]="currentQuestion"
      [progress]="getProgressObject()"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="validateAnswer()">
    </app-mcq-question>


    <app-multiple-choice-question
      *ngIf="currentQuestion.type_question?.name === 'multiple_choice'"
      [question]="currentQuestion"
      [progress]="{ current: currentQuestionIndex, total: totalQuestions, percentage: getProgressPercentage() }"
      (answerSelected)="onAnswersSelected($event)"
      (answerValidated)="validateAnswer()">
    </app-multiple-choice-question>


    <app-right-order-question
      *ngIf="currentQuestion.type_question?.name === 'right_order'"
      [question]="currentQuestion"
      [progress]="{ current: currentQuestionIndex, total: totalQuestions, percentage: getProgressPercentage() }"
      (answerSelected)="onOrderChanged($event)"
      (answerValidated)="validateAnswer()">
    </app-right-order-question>


    <app-true-false-question
      *ngIf="currentQuestion.type_question?.name === 'Vrai/Faux'"
      [question]="currentQuestion"
      [progress]="{ current: currentQuestionIndex, total: totalQuestions, percentage: getProgressPercentage() }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="validateAnswer()">
    </app-true-false-question>


    <app-matching-question
      *ngIf="currentQuestion.type_question?.name === 'matching'"
      [question]="currentQuestion"
      [progress]="{ current: currentQuestionIndex, total: totalQuestions, percentage: getProgressPercentage() }"
      (answerSelected)="onMatchingAnswersSelected($event)"
      (answerValidated)="validateAnswer()">
    </app-matching-question>


    <app-intruder-question
      *ngIf="currentQuestion.type_question?.name === 'find_the_intruder'"
      [question]="currentQuestion"
      [progress]="{ current: currentQuestionIndex, total: totalQuestions, percentage: getProgressPercentage() }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="validateAnswer()">
    </app-intruder-question>


    <app-blind-test-question
      *ngIf="currentQuestion.type_question?.name === 'blind_test'"
      [question]="currentQuestion"
      [progress]="{ current: currentQuestionIndex, total: totalQuestions, percentage: getProgressPercentage() }"
      (answerSelected)="onAnswerSelected($event)"
      (answerValidated)="validateAnswer()">
    </app-blind-test-question>

  </div>

  <div *ngIf="showFeedback"
       @slideFeedback
       class="full-feedback"
       [class.correct]="overlayCorrect"
       [class.incorrect]="!overlayCorrect">

    <div class="ff-content">
      <h1 class="ff-title">
        {{ overlayCorrect ? 'Bonne r√©ponse!' : 'Mauvaise r√©ponse!' }}
      </h1>

      <p class="ff-score">Score: {{ getCurrentNormalizedScore() }}/100</p>

      <div *ngIf="currentQuestion" class="ff-correct-list">
        <h3>Bonne(s) r√©ponse(s)&nbsp;:</h3>
        <ng-container *ngFor="let answer of currentQuestion.answers">
          <span *ngIf="answer.is_correct" class="ff-answer">{{ answer.answer }}</span>
        </ng-container>
      </div>
    </div>
  </div>



  <div *ngIf="quizCompleted" class="quiz-end-screen">

    <div class="end-content">
      <app-back-button>

      </app-back-button>
      <h1 class="end-title">Quiz termin√© !</h1>
      <div class="background-blob">

        <div class="final-score">
          <div class="score-circle">
            <span class="score-text">Votre score est de :</span>
            <span class="score-number">{{ totalScore }}</span>
            <span class="score-max">/ 100</span>
          </div>
        </div>


        <div class="ranking-section">
          <h2>Votre classement</h2>
          <div class="ranking-position">
            <span class="position-badge">#{{ playerRank }}</span>
            <span class="position-text">/ sur {{ totalPlayers }} joueurs</span>
          </div>

          <app-slide-button
            class="leaderboard-btn"
            label="Voir le classement complet"
            [negative]="true"
            backgroundColor="var(--color-dark)"
            (buttonClick)="showFullLeaderboard()">
          </app-slide-button>
        </div>
        <div class="end-actions">
          <button class="share-btn" (click)="shareQuiz()"><tui-icon icon="@tui.share-2"/> Partager</button>
          <button class="back-btn" (click)="replayQuiz()"><tui-icon icon="@tui.rotate-ccw" [style.color]="'var(--color-ligth)'"/> Rejouer</button>
        </div>
      </div>


      <div class="rating-circle">
        <div class="rating-section">
          <h3>Noter ce quiz</h3>
          <div class="star-rating">
          <span
            *ngFor="let star of [1,2,3,4,5]"
            class="star"
            [class.filled]="star <= userRating"
            [class.hover]="star <= hoverRating"
            (click)="rateQuiz(star)"
            (mouseenter)="hoverRating = star"
            (mouseleave)="hoverRating = 0">
            <tui-icon
              icon="@tui.star"
              [style.color]="(star <= userRating || star <= hoverRating) ? '#ffd700' : 'rgba(255, 255, 255, 0.3)'">
            </tui-icon>
          </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showFullLeaderboardScreen" class="full-leaderboard-screen">
    <div class="leaderboard-header">
      <h1>Classement complet</h1>
      <p>R√©sultats finaux de la partie</p>
      <button class="close-leaderboard" (click)="closeFullLeaderboard()">√ó</button>
    </div>

    <div class="leaderboard-content">
      <div class="user-highlight" *ngIf="currentUser">
        <div class="highlight-card">
          <div class="user-rank">#{{ playerRank }}</div>
          <div class="user-info">
            <div class="user-name">{{ currentUser.username }}</div>
            <div class="user-company">Votre r√©sultat</div>
          </div>
          <div class="user-score">{{ totalScore }} pts</div>
        </div>
      </div>

      <div class="leaderboard-list">
        <div *ngFor="let player of finalLeaderboard; let i = index"
             class="leaderboard-item"
             [class.current-user]="player.username === currentUser?.username">
          <div class="rank">
            <span class="rank-number">{{ player.rank }}</span>
            <span class="rank-medal" *ngIf="player.rank === 1">ü•á</span>
            <span class="rank-medal" *ngIf="player.rank === 2">ü•à</span>
            <span class="rank-medal" *ngIf="player.rank === 3">ü•â</span>
          </div>
          <div class="player-info">
            <div class="player-name">{{ player.username }}</div>
            <div class="player-company">{{ player.correctAnswers }}/{{ player.totalQuestions }} bonnes r√©ponses</div>
          </div>
          <div class="player-score">{{ player.score }} pts</div>
        </div>
      </div>

      <div class="leaderboard-stats">
        <div class="stat">
          <span class="stat-label">Questions totales</span>
          <span class="stat-value">{{ totalQuestions }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Joueurs participants</span>
          <span class="stat-value">{{ totalPlayers }}</span>
        </div>
        <div class="stat">
          <span class="stat-label">Votre rang</span>
          <span class="stat-value">#{{ playerRank }}</span>
        </div>
      </div>

      <div class="leaderboard-actions">
        <button class="action-btn primary" (click)="replayQuiz()">Rejouer</button>
        <button class="action-btn secondary" (click)="shareQuiz()">Partager</button>
        <button class="action-btn tertiary" (click)="closeFullLeaderboard()">Fermer</button>
      </div>
    </div>
  </div>

</div>
