<div class="background">
  <div class="quiz-creation-container">
    <div class="header">
      <h1>{{ isEditMode ? 'Modifier le quiz' : 'Créer un nouveau quiz' }}</h1>
      <p>{{ isEditMode ? 'Modifiez votre quiz avec des questions et réponses' : 'Créez un quiz personnalisé avec des questions et réponses' }}</p>
    </div>

    <form [formGroup]="quizForm" class="quiz-form" (ngSubmit)="onSubmit()">
      <div class="form-section">
        <h2>Informations générales</h2>

        <div class="form-group">
          <label for="title">Titre du quiz *</label>
          <input id="title" type="text" formControlName="title" class="form-input" placeholder="Entrez le titre du quiz">
          <div *ngIf="quizForm.get('title')?.invalid && quizForm.get('title')?.touched" class="error">
            Le titre est requis (min 3 caractères)
          </div>
        </div>

        <div class="form-group category-search">
          <label for="categorySearch">Catégorie *</label>
          <input
            id="categorySearch"
            type="text"
            [(ngModel)]="categorySearch"
            [ngModelOptions]="{ standalone: true }"
            (input)="filterCategories()"
            (focus)="showCategoryDropdown = true"
            class="form-input"
            placeholder="Rechercher une catégorie..."
            autocomplete="off" />

          <ul *ngIf="showCategoryDropdown && filteredCategories.length > 0" class="dropdown-list">
            <li *ngFor="let cat of filteredCategories" (click)="selectCategory(cat)">
              {{ cat.name }}
            </li>
          </ul>

          <div *ngIf="showCategoryDropdown && filteredCategories.length === 0 && categorySearch" class="no-results">
            Aucune catégorie trouvée
          </div>

          <div *ngIf="selectedCategory" class="selected-category">
            Catégorie sélectionnée : <strong>{{ selectedCategory.name }}</strong>
            <button type="button" (click)="clearCategory()" class="clear-btn">×</button>
          </div>

          <div *ngIf="quizForm.get('category')?.invalid && quizForm.get('category')?.touched" class="error">
            Veuillez sélectionner une catégorie
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description *</label>
          <textarea id="description" formControlName="description" class="form-textarea" rows="3" placeholder="Décrivez le contenu du quiz"></textarea>
          <div *ngIf="quizForm.get('description')?.invalid && quizForm.get('description')?.touched" class="error">
            La description est requise (min 10 caractères)
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="status">Statut</label>
            <select id="status" formControlName="status" class="form-select">
              <option value="">Sélectionnez un statut</option>
              <option *ngFor="let status of statuses" [value]="status.value">{{status.name}}</option>
            </select>
            <div *ngIf="statuses.length === 0" class="loading">Chargement des statuts...</div>
          </div>

          <div class="form-group">
            <label>Visibilité *</label>
            <div class="radio-group">
              <label><input type="radio" formControlName="is_public" [value]="true"> Public</label>
              <label><input type="radio" formControlName="is_public" [value]="false"> Privé</label>
            </div>
          </div>
        </div>

        <div class="form-group" *ngIf="quizForm.get('is_public')?.value === false">
          <label for="groups">Groupes autorisés *</label>
          <select id="groups" formControlName="groups" multiple class="form-select">
            <option *ngFor="let group of groups" [value]="group.id">{{group.name}}</option>
          </select>
          <small>Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs groupes</small>
        </div>
      </div>

      <div class="form-section">
        <div class="section-header">
          <h2>Questions</h2>
        </div>

        <div formArrayName="questions">
          <div *ngFor="let question of questions.controls; let i = index" [formGroupName]="i" class="question-card">
            <div class="question-header">
              <h3>Question {{i + 1}}</h3>
              <button type="button" class="btn btn-danger" (click)="removeQuestion(i)" [disabled]="questions.length <= 1">Supprimer</button>
            </div>

            <div class="form-group">
              <label>Texte de la question *</label>
              <input type="text" formControlName="question" class="form-input" placeholder="Entrez la question">
              <div *ngIf="question.get('question')?.invalid && question.get('question')?.touched" class="error">
                La question est requise (min 5 caractères)
              </div>
            </div>

            <div class="form-group">
              <label>Type de question *</label>
              <select formControlName="type_question" class="form-select" (change)="onQuestionTypeChange(i)">
                <option value="">Sélectionnez un type</option>
                <option *ngFor="let type of typeQuestions" [value]="type.key">{{type.name}}</option>
              </select>
              <div *ngIf="typeQuestions.length === 0" class="loading">Chargement des types...</div>
              <div *ngIf="question.get('type_question')?.invalid && question.get('type_question')?.touched" class="error">
                Veuillez sélectionner un type de question
              </div>
            </div>

            <div class="form-group">
              <label>Difficulté *</label>
              <select formControlName="difficulty" class="form-select">
                <option *ngFor="let difficulty of difficulties" [value]="difficulty.value">{{difficulty.label}}</option>
              </select>
              <div *ngIf="question.get('difficulty')?.invalid && question.get('difficulty')?.touched" class="error">
                Veuillez sélectionner une difficulté
              </div>
            </div>

            <div formArrayName="answers" *ngIf="question.get('type_question')?.value">
              <h4>
                Réponses
                <small>({{getQuestionTypeLabel(question.get('type_question')?.value)}})</small>
              </h4>

              <div *ngIf="question.get('type_question')?.value === 'matching'" class="matching-interface">
                <div class="matching-pairs">
                  <div *ngFor="let pairIndex of getMatchingPairs(i); let pairNum = index" class="matching-pair">
                    <h5>Paire {{pairNum + 1}}</h5>
                    <div class="pair-container">
                      <div class="left-element">
                        <label>Élément A:</label>
                        <input type="text"
                               [formControl]="getAnswerControlByPairId(i, 'left_' + (pairNum + 1))"
                               class="form-input"
                               placeholder="Élément à associer">
                      </div>
                      <div class="association-arrow">↔</div>
                      <div class="right-element">
                        <label>Élément B:</label>
                        <input type="text"
                               [formControl]="getAnswerControlByPairId(i, 'right_' + (pairNum + 1))"
                               class="form-input"
                               placeholder="Élément associé">
                      </div>
                    </div>
                  </div>
                </div>
                <button type="button" class="btn" (click)="addMatchingPair(i)">+ Ajouter une paire</button>
              </div>

              <div *ngIf="question.get('type_question')?.value === 'true_false'" class="true-false-interface">
                <div class="true-false-explanation">
                  <p><strong>Instructions :</strong> Indiquez si l'affirmation ci-dessus est vraie ou fausse.</p>
                </div>

                <div class="true-false-choice">
                  <h5>Cette affirmation est :</h5>
                  <div class="radio-group-vertical">
                    <label class="radio-option true-option">
                      <input type="radio"
                             [value]="true"
                             [checked]="getTrueFalseCorrectAnswer(i)"
                             (change)="onTrueFalseCorrectAnswerChange(i, true)">
                      <span class="radio-custom"></span>
                      <span class="radio-text">
                        <strong>VRAIE</strong>
                        <small>L'affirmation est correcte</small>
                      </span>
                    </label>

                    <label class="radio-option false-option">
                      <input type="radio"
                             [value]="false"
                             [checked]="!getTrueFalseCorrectAnswer(i)"
                             (change)="onTrueFalseCorrectAnswerChange(i, false)">
                      <span class="radio-custom"></span>
                      <span class="radio-text">
                        <strong>FAUSSE</strong>
                        <small>L'affirmation est incorrecte</small>
                      </span>
                    </label>
                  </div>
                </div>

                <div class="auto-answers-info">
                  <small class="text-muted">
                    Les réponses "Vrai" et "Faux" sont automatiquement créées selon votre choix.
                  </small>
                </div>
              </div>

              <div *ngIf="question.get('type_question')?.value !== 'matching' && question.get('type_question')?.value !== 'true_false'">
                <button type="button" class="btn" (click)="addAnswer(i)" [disabled]="!canAddAnswer(i)">
                  + Ajouter une réponse
                  <span *ngIf="question.get('type_question')?.value === 'find_the_intruder' && !canAddAnswer(i)">
                    (Max 3 pour les intrus)
                  </span>
                </button>

                <div *ngFor="let answer of getAnswers(i).controls; let j = index" [formGroupName]="j" class="answer-item">
                  <div class="answer-content">
                    <input type="text" formControlName="answer" class="form-input"
                           [placeholder]="getAnswerPlaceholder(question.get('type_question')?.value, j)">

                    <div *ngIf="question.get('type_question')?.value === 'MCQ' ||
                                question.get('type_question')?.value === 'multiple_choice'">
                      <label>
                        <input type="checkbox" formControlName="is_correct" (change)="onCorrectAnswerChange(i, j)">
                        Réponse correcte
                      </label>
                    </div>

                    <div *ngIf="question.get('type_question')?.value === 'right_order'">
                      <label>
                        Ordre correct:
                        <input type="number" formControlName="order_correct" class="form-input small" min="1" [max]="getAnswers(i).length">
                      </label>
                    </div>

                    <div *ngIf="question.get('type_question')?.value === 'find_the_intruder'">
                      <label>
                        <input type="checkbox" formControlName="is_intrus" (change)="onCorrectAnswerChange(i, j)">
                        C'est l'intrus
                      </label>
                    </div>

                    <div *ngIf="question.get('type_question')?.value === 'blind_test'">
                      <label>
                        <input type="checkbox" formControlName="is_correct" (change)="onCorrectAnswerChange(i, j)">
                        Bonne réponse
                      </label>
                    </div>
                  </div>

                  <button type="button" class="btn btn-danger" (click)="removeAnswer(i, j)"
                          [disabled]="!canRemoveAnswer(i)">
                    Supprimer
                  </button>

                  <div *ngIf="answer.get('answer')?.invalid && answer.get('answer')?.touched" class="error">
                    La réponse est requise
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="add-question-container">
          <button type="button" class="btn btn-add-question" (click)="addQuestion()">+ Ajouter une question</button>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="cancel()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting || quizForm.invalid">
          <span *ngIf="isSubmitting">{{ isEditMode ? 'Modification en cours...' : 'Création en cours...' }}</span>
          <span *ngIf="!isSubmitting">{{ isEditMode ? 'Modifier le quiz' : 'Créer le quiz' }}</span>
        </button>
      </div>
    </form>
  </div>
</div>
