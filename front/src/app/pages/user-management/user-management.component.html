<div class="container">
  <h1>Gestion <br /> des utilisateurs</h1>

  <div class="filters-container">
    <div class="filters-row">
      <select class="form-control" [(ngModel)]="filterOrg" (ngModelChange)="applyFilters()">
        <option value="">Organisation</option>
        <option *ngFor="let org of orgOptions" [value]="org">{{ org }}</option>
      </select>

      <select class="form-control" [(ngModel)]="filterRight" (ngModelChange)="applyFilters()">
        <option value="">Droits</option>
        <option *ngFor="let right of rightsOptions" [value]="right">{{ right }}</option>
      </select>

      <input
        type="text"
        class="form-control"
        placeholder="Mot-clé"
        [(ngModel)]="filterKeyword"
        (ngModelChange)="applyFilters()"
      />

      <button tuiButton class="form-control" (click)="applyFilters()">Rechercher</button>
    </div>

    <div class="dropdown-wrapper">
      <div
        tuiDropdownLimitWidth="fixed"
        tuiGroup
        [tuiDropdown]="dropdown"
        [(tuiDropdownOpen)]="open"
        class="dropdown-container"
      >
        <button class="custom-dropdown-btn">Gérer les entreprises</button>
        <button
          #tuiDropdownHost
          tuiChevron
          tuiIconButton
          class="custom-dropdown-chevron"
          type="button"
        ></button>
      </div>

      <ng-template #dropdown>
        <tui-data-list>
          <button *ngFor="let item of items" tuiOption type="button" (click)="onClick()">
            {{ item }}
          </button>
        </tui-data-list>
      </ng-template>
    </div>
  </div>

  <div *ngIf="loadError" class="error">Impossible de charger les utilisateurs.</div>

  <div class="table-scroll-wrapper"><table
    tuiTable
    [size]="size"
    class="custom-table"
    [tuiSortBy]="sortColumn"
    [direction]="sortDirection === 'asc' ? 1 : -1"
    (tuiSortChange)="onSortChange($event)"
  >

      <thead>
      <tr>
        <th tuiTh>
          <input type="checkbox" tuiCheckbox [ngModel]="allSelected" (ngModelChange)="toggleAll($event)" />
        </th>

        <th tuiTh tuiSortable="name">Utilisateur</th>
        <th tuiTh tuiSortable="active">Actif</th>
        <th tuiTh tuiSortable="organization">Organisation</th>
        <th tuiTh tuiSortable="stats">Statistiques</th>
        <th tuiTh>Droits</th>
        <th tuiTh>Action</th>
      <th tuiTh>
        Action
        <button
          tuiButton
          appearance="action"
          size="xs"
          iconStart="@tui.trash"
          tuiIconButton
          (click)="deleteSelected()"
          [disabled]="!hasSelection"
        ></button>
      </th>
    </tr>
    </thead>

    <tbody tuiTbody>
    <tr *ngFor="let row of pagedRows">
      <td tuiTd>
        <input type="checkbox" tuiCheckbox [(ngModel)]="row.selected" />
      </td>
      <td tuiTd>
        <div [tuiCell]="size" class="d-flex align-center gap-2">
          <tui-avatar [size]="size"></tui-avatar>
          <div>
            <div tuiTitle>{{ row.name }}</div>
            <div tuiSubtitle>{{ row.email }}</div>
          </div>
        </div>
      </td>
      <td tuiTd>
        <span
          class="status-indicator"
          [class.active]="row.active"
          [class.inactive]="!row.active"
        ></span>
        {{ row.active ? 'Oui' : 'Non' }}
      </td>
      <td tuiTd>
        {{ row.organization }}
        <br />
        <span class="group">{{ row.group }}</span>
      </td>
      <td tuiTd>
        <button tuiButton appearance="action-grayscale" size="s">
          {{ row.stats }} <span>Voir plus</span>
        </button>
      </td>
      <td tuiTd>
        <tui-items-with-more [style.gap.rem]="'0.25'">
          <ng-container *ngFor="let perm of row.rights">
            <tui-badge *tuiItem>{{ perm }}</tui-badge>
          </ng-container>
          <ng-template let-number tuiMore>
            <button
              tuiButton
              appearance="action-grayscale"
              size="s"
              tuiLink
              [pseudo]="true"
              tuiDropdownOpen
              tuiDropdownAlign="right"
              [tuiDropdown]="dropdown"
              iconStart="@tui.pencil"
            >
              +{{ row.rights.length - number - 1 }}
            </button>
            <ng-template #dropdown>
              <div [style.padding.rem]="'1'">
                <ng-container *ngFor="let perm of row.rights; let i = index">
                  <tui-badge *ngIf="i > number">{{ perm }}</tui-badge>
                </ng-container>
              </div>
            </ng-template>
          </ng-template>
          <span *ngIf="!row.rights.length">—</span>
        </tui-items-with-more>
      </td>
      <td tuiTd>
        <div class="d-flex gap-2">
          <a>Voir le profil</a>
          <button tuiButton appearance="action" size="xs" iconStart="@tui.pencil" tuiIconButton></button>
          <button tuiButton appearance="action" size="xs" iconStart="@tui.trash" tuiIconButton></button>
        </div>
      </td>
    </tr>

    <tr *ngIf="rows.length === 0">
      <td tuiTd colspan="7">Aucun utilisateur trouvé.</td>
    </tr>
    </tbody>
  </table>
  </div>

  <div class="pagination-container">
    <app-pagination
      [totalItems]="rows.length"
      [pageSize]="pageSize"
      [page]="page"
      [activePadding]="2"
      (pageChange)="onPageChange($event)"
    ></app-pagination>
  </div>
</div>
