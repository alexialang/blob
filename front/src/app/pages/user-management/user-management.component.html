<div class="container">
  <h1>Gestion <br /> des utilisateurs</h1>

  <div class="filters mb-4 d-flex gap-2 align-center">
    <select
      class="form-control"
      [(ngModel)]="filterOrg"
      (ngModelChange)="applyFilters()"
    >
      <option value="">Toutes les organisations</option>
      <option *ngFor="let org of orgOptions" [value]="org">
        {{ org }}
      </option>
    </select>

    <select
      class="form-control"
      [(ngModel)]="filterRight"
      (ngModelChange)="applyFilters()"
    >
      <option value="">Tous les droits</option>
      <option *ngFor="let right of rightsOptions" [value]="right">
        {{ right }}
      </option>
    </select>

    <input
      type="text"
      class="form-control"
      placeholder="Mot-clé"
      [(ngModel)]="filterKeyword"
      (ngModelChange)="applyFilters()"
    />

    <button tuiButton appearance="primary" size="s" (click)="applyFilters()">
      Rechercher
    </button>
  </div>


  <div class="actions mb-4">
    <button
      tuiButton
      appearance="primary"
      size="s"
      (click)="deleteSelected()"
      [disabled]="!hasSelection"
    >
      Supprimer la sélection
    </button>
  </div>

  <div *ngIf="loadError" class="error">
    Impossible de charger les utilisateurs.
  </div>

  <table tuiTable [size]="size" class="custom-table">
    <thead>
    <tr>
      <th tuiTh>
        <input
          type="checkbox"
          tuiCheckbox
          [ngModel]="allSelected"
          (ngModelChange)="toggleAll($event)"
        />
      </th>
      <th tuiTh>Utilisateur</th>
      <th tuiTh>Actif</th>
      <th tuiTh>Organisation</th>
      <th tuiTh>Statistiques</th>
      <th tuiTh>Droits</th>
      <th tuiTh>Action</th>
    </tr>
    </thead>
    <tbody tuiTbody>
    <tr *ngFor="let row of rows">
      <td tuiTd>
        <input type="checkbox" tuiCheckbox [(ngModel)]="row.selected" />
      </td>
      <td tuiTd>
        <div [tuiCell]="size" class="d-flex align-center gap-2">
          <tui-avatar [size]="size"></tui-avatar>
          <div>
            <div tuiTitle>{{ row.name }}</div>
            <div tuiSubtitle>{{ row.email }}</div>
          </div>
        </div>
      </td>
      <td tuiTd>
          <span [tuiStatus]="row.active ? 'positive' : 'warning'">
            {{ row.active ? 'Oui' : 'Non' }}
          </span>
      </td>
      <td tuiTd>{{ row.organization }}</td>
      <td tuiTd>
        <button tuiButton appearance="action-grayscale" size="s">
          {{ row.stats }}
          <span *ngIf="row.stats">Voir plus</span>
        </button>
      </td>
      <td tuiTd>
        <tui-items-with-more [style.gap.rem]="'0.25'">
          <ng-container *ngFor="let perm of row.rights">
            <tui-badge *tuiItem>{{ perm }}</tui-badge>
          </ng-container>
          <ng-template let-number tuiMore>
            <button
              appearance="action-grayscale"
              tuiDropdownAlign="right"
              tuiDropdownOpen
              tuiLink
              [pseudo]="true"
              [tuiDropdown]="dropdown"
            >
              +{{ row.rights.length - number - 1 }}
            </button>
            <ng-template #dropdown>
              <div [style.padding.rem]="'1'">
                <ng-container
                  *ngFor="let perm of row.rights; let i = index"
                >
                  <tui-badge *ngIf="i > number">{{ perm }}</tui-badge>
                </ng-container>
              </div>
            </ng-template>
          </ng-template>
          <span *ngIf="!row.rights.length">—</span>
        </tui-items-with-more>
      </td>
      <td tuiTd>
        <div class="d-flex gap-2">
          <button
            tuiButton
            appearance="action"
            size="xs"
            iconStart="@tui.eye"
            tuiIconButton
          >
            Voir
          </button>
          <button
            tuiButton
            appearance="action"
            size="xs"
            iconStart="@tui.pencil"
            tuiIconButton
          ></button>
          <button
            tuiButton
            appearance="action"
            size="xs"
            iconStart="@tui.trash"
            tuiIconButton
          ></button>
        </div>
      </td>
    </tr>
    <tr *ngIf="rows.length === 0">
      <td tuiTd colspan="7">Aucun utilisateur trouvé.</td>
    </tr>
    </tbody>
  </table>
</div>
